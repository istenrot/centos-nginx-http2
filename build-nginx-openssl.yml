---
- hosts: all
  remote_user: vagrant
  vars_files:
  - variables.yml
  vars:
    nginx_src_rpm: "nginx-{{ nginx_ver }}.el7.ngx.src.rpm"
    pkg_release: "{{ release_ver }}.el7.sse2"
  tasks:
  - name: Install EPEL Yum repo
    yum: name=epel-release state=present
    become: yes
    become_user: root
  - name: Install build tools from CentOS repos
    yum: name={{ item }} state=present
    become: yes
    become_user: root
    with_items:
    - ca-certificates
    - curl
    - libcurl
    - git
    - glib2
    - rsync
    - make
    - patch
    - bzip2
    - xz
    - tar
    - autoconf
    - automake
    - libtool
    - zlib-devel
    - glibc-devel
    - libaio-devel
    - pcre-devel
    - nss-devel
    - nss-softokn-devel
    - nss-softokn-freebl-devel
    - nspr-devel
    - libgcrypt-devel
    - libgpg-error-devel
    - libatomic_ops-devel
    - libxslt-devel
    - gd-devel
    - GeoIP-devel
    - rpm-build
    - redhat-rpm-config
    - mock
    - scl-utils
    - centos-release-scl-rh
  - name: Install build tools from Devtoolset-3 repo
    yum: name={{ item }} state=present
    become: yes
    become_user: root
    with_items:
    - devtoolset-3-binutils
    - devtoolset-3-gcc
    - devtoolset-3-gcc-c++
  - name: Delete recursively old rpmbuild directory
    file: dest=rpmbuild state=absent
  - name: Create new rpmbuild directory
    file: dest=rpmbuild/BUILD state=directory recurse=yes
  - name: Download Nginx RPM source package
    get_url: url=http://nginx.org/packages/mainline/centos/7/SRPMS/{{ nginx_src_rpm }} dest=~/rpmbuild/nginx-src.rpm
  - name: Extract Nginx RPM source package
    shell: rpm -i ~/rpmbuild/nginx-src.rpm
  - name: Create pcre directory
    file: dest=rpmbuild/BUILD/pcre state=directory
  - name: Download latest PCRE
    shell: curl -s -S -L 'http://sourceforge.net/projects/pcre/files/latest/download?source=navbar' | tar -C rpmbuild/BUILD/pcre --strip-components=1 -xj
  - name: Create openssl directory
    file: dest=rpmbuild/BUILD/openssl state=directory
  - name: Download OpenSSL
    shell: curl -s -S -L http://www.openssl.org/source/{{ openssl_src }}.tar.gz | tar -C rpmbuild/BUILD/openssl --strip-components=1 -xz
  - name: Download CloudFlare CHACHA20-POLY1305 patch for OpenSSL 1.0.2g
    get_url: url=https://raw.githubusercontent.com/cloudflare/sslconfig/master/patches/openssl__chacha20_poly1305_draft_and_rfc_ossl102g.patch dest=~/rpmbuild/openssl__chacha20_poly1305_cf.patch
  - name: Apply CHACHA20-POLY1305 patch to OpenSSL
    shell: patch -p1 < ~/rpmbuild/openssl__chacha20_poly1305_cf.patch
    args:
      chdir: ~/rpmbuild/BUILD/openssl
  - name: Run OpenSSL configure script to apply CHACHA20-POLY1305
    shell: source /opt/rh/devtoolset-3/enable && ./config
    args:
      chdir: ~/rpmbuild/BUILD/openssl
  - name: Create ngx_pagespeed directory
    file: dest=rpmbuild/BUILD/ngx_pagespeed state=directory
  - name: Download ngx_pagespeed module source
    shell: curl -s -S -L https://github.com/pagespeed/ngx_pagespeed/archive/v{{ nps_release }}-beta.tar.gz | tar -C rpmbuild/BUILD/ngx_pagespeed --strip-components=1 -xz
  - name: Download psol library
    shell: curl -s -S -L https://dl.google.com/dl/page-speed/psol/{{ nps_release }}.tar.gz | tar -C rpmbuild/BUILD/ngx_pagespeed -xz
  - name: Copy RPM spec file to Vagrant box
    copy: src=specs/nginx.spec dest=rpmbuild/SPECS/nginx.spec
  - name: Build RPM packages
    shell: source /opt/rh/devtoolset-3/enable && rpmbuild -ba rpmbuild/SPECS/nginx.spec

